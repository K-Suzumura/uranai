<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ã„ã®é¤¨</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .input-row {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label {
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
        }
        button:hover {
            background: #5a67d8;
        }
        .result-section {
            display: none;
        }
        .meishiki-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .meishiki-table th, .meishiki-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        .meishiki-table th {
            background: #667eea;
            color: white;
        }
        .pillar {
            background: #f8f9fa;
        }
        .analysis-section {
            margin-top: 30px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .analysis-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border-left: 5px solid #667eea;
        }
        .analysis-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        .element-balance {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .element-bar {
            flex: 1;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
            color: white;
        }
        .wood { background: #4a7c59; }
        .fire { background: #e63946; }
        .earth { background: #8b4513; }
        .metal { background: #708090; }
        .water { background: #2a9d8f; }
        .stem-select, .branch-select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        .daiunn-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .daiunn-table {
            width: 100%;
            margin-top: 10px;
            font-size: 14px;
        }
        .daiunn-table th {
            background: #667eea;
            color: white;
            padding: 5px;
        }
        .daiunn-table td {
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .transformed {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”® å ã„ã®é¤¨ ğŸ”®</h1>
        
        <div class="input-section">
            <h2>ç”Ÿå¹´æœˆæ—¥ã€å‡ºç”Ÿæ™‚åˆ»ã€æ€§åˆ¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
            <div class="input-row">
                <div class="input-group">
                    <label>ç”Ÿå¹´æœˆæ—¥ï¼š</label>
                    <input type="date" id="birthDate" value="1990-01-01">
                </div>
                <div class="input-group">
                    <label>å‡ºç”Ÿæ™‚åˆ»ï¼š</label>
                    <input type="time" id="birthTime" value="12:00">
                </div>
                <div class="input-group">
                    <label>æ€§åˆ¥ï¼š</label>
                    <select id="gender">
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                    </select>
                </div>
                <button onclick="calculate()">å‘½å¼ã‚’ç®—å‡ºã™ã‚‹</button>
            </div>
        </div>
        
        <div id="resultSection" class="result-section">
            <h2>å‘½å¼</h2>
            <table class="meishiki-table">
                <thead>
                    <tr>
                        <th>ç¨®é¡</th>
                        <th>æ™‚æŸ±</th>
                        <th>æ—¥æŸ±</th>
                        <th>æœˆæŸ±</th>
                        <th>å¹´æŸ±</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="pillar">
                        <td><strong>å¤©å¹²</strong></td>
                        <td>
                            <select id="hourStem" class="stem-select" onchange="updateAnalysis()">
                                <option value="">-</option>
                            </select>
                        </td>
                        <td style="background: #ffd700;">
                            <select id="dayStem" class="stem-select" onchange="updateAnalysis()">
                                <option value="">-</option>
                            </select>
                        </td>
                        <td>
                            <select id="monthStem" class="stem-select" onchange="updateAnalysis()">
                                <option value="">-</option>
                            </select>
                        </td>
                        <td>
                            <select id="yearStem" class="stem-select" onchange="updateAnalysis()">
                                <option value="">-</option>
                            </select>
                        </td>
                    </tr>
                    <tr class="pillar">
                        <td><strong>åœ°æ”¯</strong></td>
                        <td>
                            <select id="hourBranch" class="branch-select" onchange="updateAnalysis()">
                                <option value="">-</option>
                            </select>
                        </td>
                        <td>
                            <select id="dayBranch" class="branch-select" onchange="updateAnalysis()">
                                <option value="">-</option>
                            </select>
                        </td>
                        <td>
                            <select id="monthBranch" class="branch-select" onchange="updateAnalysis()">
                                <option value="">-</option>
                            </select>
                        </td>
                        <td>
                            <select id="yearBranch" class="branch-select" onchange="updateAnalysis()">
                                <option value="">-</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>è”µå¹²</strong></td>
                        <td id="hourHidden"></td>
                        <td id="dayHidden"></td>
                        <td id="monthHidden"></td>
                        <td id="yearHidden"></td>
                    </tr>
                    <tr>
                        <td><strong>è”µå¹²é€šå¤‰æ˜Ÿ</strong></td>
                        <td id="hourHiddenGod"></td>
                        <td id="dayHiddenGod"></td>
                        <td id="monthHiddenGod"></td>
                        <td id="yearHiddenGod"></td>
                    </tr>
                    <tr>
                        <td><strong>é€šå¤‰æ˜Ÿ</strong></td>
                        <td id="hourGod"></td>
                        <td>æ—¥ä¸»</td>
                        <td id="monthGod"></td>
                        <td id="yearGod"></td>
                    </tr>
                    <tr>
                        <td><strong>åäºŒé‹</strong></td>
                        <td id="hour12"></td>
                        <td id="day12"></td>
                        <td id="month12"></td>
                        <td id="year12"></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="analysis-section">
                <h2>å ã„çµæœ</h2>
                <div id="analysisResult"></div>
            </div>
            
            <div class="daiunn-section" id="daiunnSection" style="display: none;">
                <h3>å¤§é‹ï¼ˆ10å¹´ã”ã¨ã®é‹å‹¢ï¼‰</h3>
                <div id="daiunnResult"></div>
            </div>
        </div>
    </div>

    <script>
        // Data definitions
        const heavenlyStems = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
        const stemElements = { 'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´' };
        const stemYinYang = { 'ç”²': 'é™½', 'ä¹™': 'é™°', 'ä¸™': 'é™½', 'ä¸': 'é™°', 'æˆŠ': 'é™½', 'å·±': 'é™°', 'åºš': 'é™½', 'è¾›': 'é™°', 'å£¬': 'é™½', 'ç™¸': 'é™°' };
        const earthlyBranches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
        const branchElements = { 'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨', 'è¾°': 'åœŸ', 'å·³': 'ç«', 'åˆ': 'ç«', 'æœª': 'åœŸ', 'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´' };
        const twelveStages = ['èƒ', 'é¤Š', 'é•·ç”Ÿ', 'æ²æµ´', 'å† å¸¯', 'å»ºç¦„', 'å¸æ—º', 'è¡°', 'ç—…', 'æ­»', 'å¢“', 'çµ¶'];

        const elements = {
            wood: ['ç”²', 'ä¹™', 'å¯…', 'å¯'],
            fire: ['ä¸™', 'ä¸', 'å·³', 'åˆ'],
            earth: ['æˆŠ', 'å·±', 'ä¸‘', 'è¾°', 'æœª', 'æˆŒ'],
            metal: ['åºš', 'è¾›', 'ç”³', 'é…‰'],
            water: ['å£¬', 'ç™¸', 'å­', 'äº¥']
        };

        const kakkyokuDescriptions = {
            // Normal Patterns
            'å»ºç¦„æ ¼': { title: 'ç›®çš„ã®ãŸã‚ã«é ‘å¼µã‚ŠãŒããå‰µæ¥­è€…', description: 'ç‹¬ç«‹å¿ƒãŒæ—ºç››ã§ã€ç‡ç›´ã§å‘ã“ã†æ°—ã®å¼·ã„äººã§ã™ã€‚è¦‹ã‹ã‘ã¯å¹³é™ã‚’è£…ã£ã¦ã„ã¦ã‚‚è² ã‘ãšå«Œã„ã€‚æ„å¿—ãŒå¼·ãã€ç›®çš„ã‚’é”ã™ã‚‹ã¾ã§å¼µã‚ŠæŠœãã¾ã™ã€‚ã©ã®ã‚ˆã†ãªå ´ã«ã‚ã£ã¦ã‚‚è‡ªåˆ†ã‚’ä¸­å¿ƒã¨ã—ãŸå½±éŸ¿åŠ›ã®æ¸¦ã‚’ä½œã‚Šã¾ã™ã€‚' },
            'æœˆåˆƒæ ¼': { title: 'èŠ¯ãŒå¼·ãå¿è€åŠ›ã®ã‚ã‚‹è¬€ç•¥å®¶', description: 'è‡ªå°Šå¿ƒãŒå¼·ã„ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ä½•ã‚’è€ƒãˆã¦ã„ã‚‹ã®ã‹åˆ†ã‹ã‚Šã«ãã„äººã§ã™ã€‚å¿ƒã®ä¸­ã§ã¯è‡ªåˆ†ã‚’é«˜ãè¦‹ã¦ãŠã‚Šã€åŠ›ãšãã§å‹æ•—ã‚’ã¤ã‘ã‚ˆã†ã¨ã™ã‚‹ç™–ãŒã‚ã‚Šã¾ã™ã€‚è² ã‘ãšå«Œã„ã§ã€å·»ãè¿”ã—ã®ãƒãƒ£ãƒ³ã‚¹ã‚’è™è¦–çœˆçœˆã¨ã­ã‚‰ã„ã¾ã™ã€‚' },
            'é£Ÿç¥æ ¼': { title: 'æ„Ÿè¦šã¨ãƒ­ãƒãƒ³ã«ç”Ÿãã‚‹èŠ¸è¡“å®¶', description: 'æ°—æŒã¡ã®ã‚ˆã„ã“ã¨ã€ãŠã„ã—ã„ã‚‚ã®ãŒå¤§å¥½ããªäººã§ã™ã€‚å¿ƒã¯åºƒãå¤§ã‚‰ã‹ã§ã€ç‰©äº‹ã«å¯¾ã—ã¦æ¥½è¦³çš„ã€‚è¯ã‚„ã‹ãªèŠ¸è¡“ã®æ‰èƒ½ã«æº€ã¡ã¦ãŠã‚Šã€æ¸©å’Œã•ã¨å„ªé›…ãªé›°å›²æ°—ã§äººã‚’é­…äº†ã—ã¾ã™ã€‚' },
            'å‚·å®˜æ ¼': { title: 'é ­ã®åˆ‡ã‚Œã®é‹­ã„æŠ€è¡“è€…', description: 'æŠ€è¡“ã®ç¿’å¾—ãŒã¨ã¦ã‚‚é€Ÿãã€å·§ã¿ã«æ–°ã—ã„æŠ€è¡“ã‚’å­¦ã³ã¾ã™ã€‚é ­ã®å›è»¢ãŒé€Ÿãã€éå¸¸ã«ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã€‚æ„Ÿè¦šçš„ã§æ´—ç·´ã•ã‚ŒãŸã‚‚ã®ã‚’å¥½ã¿ã€ã‚»ãƒ³ã‚¹ãŒã‚ˆãã¦ã€æµè¡Œã«æ•æ„Ÿã§ã™ã€‚' },
            'åè²¡æ ¼': { title: 'ç¤¾äº¤çš„ã§äººæ ¼å††æº€ãªå•†å£²äºº', description: 'äººã¥ãåˆã„ãŒã¨ã¦ã‚‚å¥½ããªäººã§ã™ã€‚äººã®é›†ã¾ã‚‹ã¨ã“ã‚ãŒå¤§å¥½ãã§ã€ç¤¾äº¤ã‚„äººåŠ©ã‘ã®ãŸã‚ã«å¹´ä¸­é£›ã³å›ã£ã¦ã„ã¾ã™ã€‚å¤šãã®äººã‚’æ¥½ã¾ã›ã€ãŸãã•ã‚“ã‚‚ã¦ãªã™ã“ã¨ã§ã€å¤§ããªä¾¡å€¤ã‚’ç”Ÿã¿å‡ºãã†ã¨ã—ã¾ã™ã€‚' },
            'æ­£è²¡æ ¼': { title: 'èª å®Ÿã§å‹¤å‹‰ã«åƒãéŠ€è¡Œãƒãƒ³', description: 'èª å®Ÿã§å‹¤å‹‰ãªäººã§ã™ã€‚è³ªå®Ÿå‰›å¥ã€ã¾ã˜ã‚ã§ä¿¡ç”¨ã•ã‚Œã¾ã™ã€‚çµŒé¨“ã‚’é‡è¦–ã—ã€äººé–“é–¢ä¿‚ã‚’å¤§åˆ‡ã«ã™ã‚‹ç©å¥æ´¾ã€‚åœ°ã«æ±—ã—ã¦åƒãã“ã¨ã‚’ã„ã¨ã‚ãšã€ã‚³ãƒ„ã‚³ãƒ„ã¨å®Ÿç¸¾ã‚’é‡ã­ã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚' },
            'åå®˜æ ¼': { title: 'å‰æ¥­ã¨åŠŸç¸¾ã‚’ä¸Šã’ã‚‹è‹±é›„', description: 'æ­£ç¾©æ„ŸãŒå¼·ãã€ç¾©ç†ã¨äººæƒ…ã«ç”Ÿãã‚‹äººã§ã™ã€‚å¼±ã„è€…ã‚’åŠ©ã‘ã€ç«¹ã‚’å‰²ã£ãŸã‚ˆã†ãªã‚µãƒƒãƒ‘ãƒªã¨ã—ãŸæ°—æ€§ã€‚äººç”Ÿã«ãŠã„ã¦å¤§ããªé‡å¿ƒã‚’æŒã¡ã€æˆ¦ã†ã“ã¨ã‚„å¤±æ•—ã‚’æã‚Œãšã€è©¦ç·´ã«ã‚‚ã‚ˆãè€ãˆã¾ã™ã€‚' },
            'æ­£å®˜æ ¼': { title: 'ç¤¼å„€ã¨è¦å¾‹ã‚’å®ˆã‚‹å›½å®¶å…¬å‹™å“¡', description: 'è¦å¾‹ã‚’å®ˆã‚Šã€çµ„ç¹”ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã†äººã§ã™ã€‚é«˜è²´ã§å„ªé›…ãªæ°—è³ªã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚çŸ¥çš„ã§ã‚ã‚Šã€è¦å‰‡ã‚’å®ˆã£ã¦é †åºã‚ˆãè¡Œå‹•ã—ã¾ã™ã€‚ã©ã®ã‚ˆã†ãªç’°å¢ƒã«ã‚ã£ã¦ã‚‚ã€æ³•ã‚’å®ˆã‚Šã€è‡ªåˆ†ã®ã“ã¨ã‚ˆã‚Šã‚‚äººã®ãŸã‚ã«å°½ãã—ã¾ã™ã€‚' },
            'åå°æ ¼': { title: 'è‡¨æ©Ÿå¿œå¤‰ã§æ™‚é–“ã«ã¨ã‚‰ã‚ã‚Œãªã„è¨˜è€…', description: 'ç‰©è³ªä¸–ç•Œã‚ˆã‚Šã‚‚ã€å†…é¢ã®ä¸–ç•Œã‚’é‡è¦–ã™ã‚‹äººã§ã™ã€‚çŸ¥çš„å¥½å¥‡å¿ƒãŒæ—ºç››ã§ã€ç›´æ„ŸãŒéå¸¸ã«ç™ºé”ã—ã¦ã„ã¦ã€ç‰©äº‹ã®æ ¸å¿ƒã‚’ã¤ã‹ã‚€æ´å¯ŸåŠ›ãŒã‚ã‚Šã¾ã™ã€‚æŸç¸›ã•ã‚Œã‚‹ã“ã¨ã‚’å«Œã„ã€å­¤ç‹¬ãªæ™‚é–“ã‚’æ¥½ã—ã‚€ã¨ã“ã‚ãŒã‚ã‚Šã¾ã™ã€‚' },
            'å°ç¶¬æ ¼': { title: 'ã‚¤ãƒ³ãƒ†ãƒªã§ç ”ç©¶ç†±å¿ƒãªå­¦è€…', description: 'å¥½å¥‡å¿ƒãŒæ—ºç››ãªäººã§ã™ã€‚è¡æ˜ã§è±Šå¯ŒãªçŸ¥è­˜ã‚’æŒã¡ã€æ§ãˆã‚ã§ã™ã€‚ä½•ã‚ˆã‚Šã‚‚å­¦ã¶ã“ã¨ãŒå¥½ãã§ã€è¨˜æ†¶åŠ›ãŒã‚ˆãã€æ§˜ã€…ãªçŸ¥è­˜ã‚’å¸åã—ã¾ã™ã€‚ä¼çµ±ã‚„ã€æ­£çµ±ãªå­¦å•ã€å­¦è¡“ã‚’é‡ã‚“ã˜ã‚‹ç§€æ‰ã§ã™ã€‚' },
            // Special Patterns (Tokubetsu Kakkyoku)
            'å¾“æ—ºæ ¼': { title: 'æˆ‘ãŒé“ã‚’æ­©ã‚€ç‹¬ç«‹ç‹¬æ­©ã®äºº', description: 'è‡ªæˆ‘ãŒéå¸¸ã«å¼·ãã€è‡ªåˆ†ã®ä¿¡å¿µã‚’è²«ãã“ã¨ã§é“ãŒé–‹ã‘ã¾ã™ã€‚å¤šãã®å‹äººã‚„å…„å¼Ÿã«åŠ©ã‘ã‚‰ã‚Œã‚‹é‹ã‚’æŒã¡ã€ãƒã‚¤ãƒšãƒ¼ã‚¹ã«ã¾ã£ã™ãé€²ã‚€äººç”Ÿã§ã™ã€‚' },
            'å¾“å¼·æ ¼': { title: 'çŸ¥çš„å¥½å¥‡å¿ƒæ—ºç››ãªå­¦ç©¶ã®äºº', description: 'å­¦ç¿’åŠ›ã«å„ªã‚Œã€å­¦å•ã‚„ç ”ç©¶ã®ä¸–ç•Œã§æ‰èƒ½ã‚’ç™ºæ®ã—ã¾ã™ã€‚å¸«ã‚„æ¯è¦ªã®ã‚ˆã†ãªå­˜åœ¨ã‹ã‚‰ã®æ•™ãˆã«ã‚ˆã£ã¦æˆé•·ã—ã€ç‹¬è‡ªã®äººç”Ÿè¦³ã‚’ç¯‰ãã¾ã™ã€‚' },
            'å¾“å…æ ¼': { title: 'èŠ¸è¡“çš„æ‰èƒ½ã«æº¢ã‚ŒãŸã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼', description: 'å‰µé€ åŠ›ã€è¡¨ç¾åŠ›ã€æŠ€è¡“åŠ›ã«éå¸¸ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚èŠ¸è¡“ã€èŠ¸èƒ½ã€ä¼ç”»ãªã©ã®åˆ†é‡ã§ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªæ‰èƒ½ã‚’æœ€å¤§é™ã«ç™ºæ®ã™ã‚‹äººç”Ÿã§ã™ã€‚' },
            'å¾“è²¡æ ¼': { title: 'äººè„ˆã¨è²¡ã‚’ç¯‰ãç¤¾äº¤çš„ãªå•†æ‰äºº', description: 'äººä»˜ãåˆã„ãŒã†ã¾ãã€ã‚µãƒ¼ãƒ“ã‚¹ç²¾ç¥ã‚’ç™ºæ®ã™ã‚‹ã“ã¨ã§å¤šãã®äººã«å¥½ã‹ã‚Œã€å·¨é¡ã®å¯Œã‚’ç¯‰ãæ‰èƒ½ãŒã‚ã‚Šã¾ã™ã€‚ãŠé‡‘ã«æ¥µã‚ã¦æµã¾ã‚ŒãŸäººç”Ÿã‚’é€ã‚Šã¾ã™ã€‚' },
            'å¾“æ®ºæ ¼': { title: 'çµ„ç¹”ã®ä¸­ã§åœ°ä½ã‚’ç¯‰ãæ¨©å¨ã®äºº', description: 'å¿è€å¼·ãã€ç®¡ç†èƒ½åŠ›ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚çµ„ç¹”ã®ä¸­ã§åºåˆ—ã¨ç§©åºã‚’å®ˆã‚Šã€ä»»å‹™ã‚’é‚è¡Œã™ã‚‹ã“ã¨ã§ã€ç¤¾ä¼šçš„ã«é«˜ã„åœ°ä½ã¨æ¨©åŠ›ã‚’å¾—ã‚‹äººç”Ÿã§ã™ã€‚' },
            'å¾“å‹¢æ ¼': { title: 'æ™‚ä»£ã®æµã‚Œã«ä¹—ã‚‹æŸ”è»Ÿãªä¸–æ¸¡ã‚Šä¸Šæ‰‹', description: 'æ§˜ã€…ãªæ‰èƒ½ã«æº€ã¡æº¢ã‚Œã€å‘¨å›²ã®çŠ¶æ³ã«æŸ”è»Ÿã«å¯¾å¿œã—ã¦ã„ãã“ã¨ã§å¹¸é‹ã‚’æ´ã¿ã¾ã™ã€‚å¯Œã«ã‚‚åœ°ä½ã«ã‚‚æµã¾ã‚Œã€å¤šãã®äººã«å¥½ã‹ã‚Œã‚‹å††æº€ãªäººç”Ÿã§ã™ã€‚' },
        };

        const hiddenStemsPriority = {
            'å­': ['ç™¸', 'å£¬'],   'ä¸‘': ['å·±', 'è¾›', 'ç™¸'],   'å¯…': ['ç”²', 'ä¸™', 'æˆŠ'],
            'å¯': ['ä¹™', 'ç”²'],   'è¾°': ['æˆŠ', 'ä¹™', 'ç™¸'],   'å·³': ['ä¸™', 'åºš', 'æˆŠ'],
            'åˆ': ['ä¸', 'å·±'],   'æœª': ['å·±', 'ä¸', 'ä¹™'],   'ç”³': ['åºš', 'å£¬', 'æˆŠ'],
            'é…‰': ['è¾›', 'åºš'],   'æˆŒ': ['æˆŠ', 'è¾›', 'ä¸'],   'äº¥': ['å£¬', 'ç”²']
        };
        
        const shinsenhyo = {
            'å¯…': [{days: 7, stem: 'ç”²'}, {days: 9, stem: 'ä¸™'}, {days: 31, stem: 'æˆŠ'}],
            'å¯': [{days: 10, stem: 'ç”²'}, {days: 31, stem: 'ä¹™'}],
            'è¾°': [{days: 9, stem: 'ä¹™'}, {days: 12, stem: 'ç™¸'}, {days: 31, stem: 'æˆŠ'}],
            'å·³': [{days: 9, stem: 'ä¸™'}, {days: 12, stem: 'åºš'}, {days: 31, stem: 'æˆŠ'}],
            'åˆ': [{days: 10, stem: 'ä¸™'}, {days: 31, stem: 'ä¸'}],
            'æœª': [{days: 9, stem: 'ä¸'}, {days: 12, stem: 'ä¹™'}, {days: 31, stem: 'å·±'}],
            'ç”³': [{days: 10, stem: 'åºš'}, {days: 13, stem: 'å£¬'}, {days: 31, stem: 'æˆŠ'}],
            'é…‰': [{days: 10, stem: 'åºš'}, {days: 31, stem: 'è¾›'}],
            'æˆŒ': [{days: 9, stem: 'è¾›'}, {days: 12, stem: 'ä¸'}, {days: 31, stem: 'æˆŠ'}],
            'äº¥': [{days: 10, stem: 'æˆŠ'}, {days: 31, stem: 'ç”²'}],
            'å­': [{days: 10, stem: 'å£¬'}, {days: 31, stem: 'ç™¸'}],
            'ä¸‘': [{days: 9, stem: 'ç™¸'}, {days: 12, stem: 'è¾›'}, {days: 31, stem: 'å·±'}]
        };

        function getSixtyPillar(index) {
            return { stem: heavenlyStems[index % 10], branch: earthlyBranches[index % 12] };
        }

        function getSetsuiriDate(year, month) {
            const setsuiriConstants = {
                1:  { name: 'å°å¯’', C: 5.4055, zodiac: 'ä¸‘' }, 2:  { name: 'ç«‹æ˜¥', C: 4.15,   zodiac: 'å¯…' },
                3:  { name: 'å•“èŸ„', C: 5.63,   zodiac: 'å¯' }, 4:  { name: 'æ¸…æ˜', C: 4.9,    zodiac: 'è¾°' },
                5:  { name: 'ç«‹å¤', C: 5.52,   zodiac: 'å·³' }, 6:  { name: 'èŠ’ç¨®', C: 5.8,    zodiac: 'åˆ' },
                7:  { name: 'å°æš‘', C: 7.1,    zodiac: 'æœª' }, 8:  { name: 'ç«‹ç§‹', C: 7.5,    zodiac: 'ç”³' },
                9:  { name: 'ç™½éœ²', C: 7.8,    zodiac: 'é…‰' }, 10: { name: 'å¯’éœ²', C: 8.3,   zodiac: 'æˆŒ' },
                11: { name: 'ç«‹å†¬', C: 7.5,   zodiac: 'äº¥' }, 12: { name: 'å¤§é›ª', C: 7.18,  zodiac: 'å­' }
            };
            const termData = setsuiriConstants[month];
            if (!termData) return null;
            const day = Math.floor(termData.C + 0.2422 * (year - 1900) - Math.floor((year - 1900) / 4));
            return { day: day, zodiac: termData.zodiac, name: termData.name };
        }

        function getMonthPillar(year, month, day, yearStem) {
            let targetMonth = month, targetYear = year;
            let setsuiri = getSetsuiriDate(targetYear, targetMonth);
            if (day < setsuiri.day) {
                targetMonth = month === 1 ? 12 : month - 1;
                if (month === 1) targetYear--;
                setsuiri = getSetsuiriDate(targetYear, targetMonth);
            }
            const monthBranch = setsuiri.zodiac;
            const yearStemIndex = heavenlyStems.indexOf(yearStem);
            const firstMonthStemIndexMap = [2, 4, 6, 8, 0];
            const firstMonthStemIndex = firstMonthStemIndexMap[yearStemIndex % 5];
            const toraMonthIndex = 2;
            const monthBranchIndex = earthlyBranches.indexOf(monthBranch);
            let monthOffset = monthBranchIndex - toraMonthIndex;
            if (monthOffset < 0) monthOffset += 12;
            const monthStemIndex = (firstMonthStemIndex + monthOffset) % 10;
            const monthStem = heavenlyStems[monthStemIndex];
            return { stem: monthStem, branch: monthBranch };
        }

        function getTenGod(dayStem, targetStem) {
            if (!dayStem || !targetStem) return '';
            const dayIndex = heavenlyStems.indexOf(dayStem);
            const targetIndex = heavenlyStems.indexOf(targetStem);
            if(dayIndex === -1 || targetIndex === -1) return '';
            const dayElement = stemElements[dayStem];
            const targetElement = stemElements[targetStem];
            const dayYinYang = stemYinYang[dayStem];
            const targetYinYang = stemYinYang[targetStem];
            if (dayElement === targetElement) return dayYinYang === targetYinYang ? 'æ¯”è‚©' : 'åŠ«è²¡';
            const elementCycle = ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'];
            const dayElementIndex = elementCycle.indexOf(dayElement);
            const targetElementIndex = elementCycle.indexOf(targetElement);
            if ((dayElementIndex + 1) % 5 === targetElementIndex) return dayYinYang === targetYinYang ? 'é£Ÿç¥' : 'å‚·å®˜';
            if ((dayElementIndex + 2) % 5 === targetElementIndex) return dayYinYang !== targetYinYang ? 'æ­£è²¡' : 'åè²¡';
            if ((dayElementIndex + 3) % 5 === targetElementIndex) return dayYinYang !== targetYinYang ? 'æ­£å®˜' : 'åå®˜';
            if ((dayElementIndex + 4) % 5 === targetElementIndex) return dayYinYang !== targetYinYang ? 'å°ç¶¬' : 'åå°';
            return '';
        }

        function getTwelveStage(stem, branch) {
            const stemIndex = heavenlyStems.indexOf(stem);
            const branchIndex = earthlyBranches.indexOf(branch);
            if(stemIndex === -1 || branchIndex === -1) return '';
            const element = stemElements[stem];
            const stageMap = {
                'æœ¨': [11, 6, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9], 'ç«': [2, 9, 3, 4, 5, 6, 7, 8, 9, 10, 11, 0],
                'åœŸ': [5, 0, 6, 7, 8, 9, 10, 11, 0, 1, 2, 3], 'é‡‘': [8, 3, 9, 10, 11, 0, 1, 2, 3, 4, 5, 6],
                'æ°´': [11, 6, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
            };
            const stageIndex = stageMap[element][branchIndex];
            return twelveStages[stageIndex];
        }

        function initializeSelects() {
            document.querySelectorAll('.stem-select').forEach(select => {
                select.innerHTML = '<option value="">-</option>';
                heavenlyStems.forEach(stem => select.add(new Option(stem, stem)));
            });
            document.querySelectorAll('.branch-select').forEach(select => {
                select.innerHTML = '<option value="">-</option>';
                earthlyBranches.forEach(branch => select.add(new Option(branch, branch)));
            });
        }

        window.onload = initializeSelects;

        function calculate() {
            const birthDateStr = document.getElementById('birthDate').value;
            const birthTime = document.getElementById('birthTime').value;
            window.currentBirthDate = new Date(`${birthDateStr}T${birthTime}`);

            const year = window.currentBirthDate.getFullYear(), month = window.currentBirthDate.getMonth() + 1, day = window.currentBirthDate.getDate();

            const risshun = getSetsuiriDate(year, 2);
            const risshunDate = new Date(year, 1, risshun.day);
            const astrologicalYear = window.currentBirthDate < risshunDate ? year - 1 : year;
            const yearPillar = getSixtyPillar((astrologicalYear - 1864) % 60);
            const monthPillar = getMonthPillar(year, month, day, yearPillar.stem);
            const baseDate = new Date(1900, 0, 1);
            const daysDiff = Math.floor((window.currentBirthDate - baseDate) / (1000 * 60 * 60 * 24));
            const dayPillar = getSixtyPillar((daysDiff + 10) % 60);
            
            const [hour, minute] = birthTime.split(':').map(Number);
            const hourBranchIndex = Math.floor((hour + 1) / 2) % 12;
            const hourBranch = earthlyBranches[hourBranchIndex];
            const dayStemIndex = heavenlyStems.indexOf(dayPillar.stem);
            const hourStemIndex = ((dayStemIndex % 5) * 2 + hourBranchIndex) % 10;
            const hourStem = heavenlyStems[hourStemIndex];

            document.getElementById('yearStem').value = yearPillar.stem;
            document.getElementById('yearBranch').value = yearPillar.branch;
            document.getElementById('monthStem').value = monthPillar.stem;
            document.getElementById('monthBranch').value = monthPillar.branch;
            document.getElementById('dayStem').value = dayPillar.stem;
            document.getElementById('dayBranch').value = dayPillar.branch;
            document.getElementById('hourStem').value = hourStem;
            document.getElementById('hourBranch').value = hourBranch;

            window.currentGender = document.getElementById('gender').value;
            
            updateAnalysis();
            document.getElementById('resultSection').style.display = 'block';
        }

        // --- Start of Kango/Shigo Logic ---
        
        const isKangoPair = (s1, s2) => {
            const pairs = [['ç”²', 'å·±'], ['ä¹™', 'åºš'], ['ä¸™', 'è¾›'], ['ä¸', 'å£¬'], ['æˆŠ', 'ç™¸']];
            return pairs.some(p => (p[0] === s1 && p[1] === s2) || (p[0] === s2 && p[1] === s1));
        };

        const isShichuPair = (b1, b2) => {
            const pairs = [['å­', 'åˆ'], ['ä¸‘', 'æœª'], ['å¯…', 'ç”³'], ['å¯', 'é…‰'], ['è¾°', 'æˆŒ'], ['å·³', 'äº¥']];
            return pairs.some(p => (p[0] === b1 && p[1] === b2) || (p[0] === b2 && p[1] === b1));
        };

        const shigoPairs = [
            { b1: 'å­', b2: 'ä¸‘', element: 'åœŸ', requiredStems: ['æˆŠ', 'å·±', 'ä¸™', 'ä¸'] },
            { b1: 'äº¥', b2: 'å¯…', element: 'æœ¨', requiredStems: ['ç”²', 'ä¹™', 'å£¬', 'ç™¸'] },
            { b1: 'å¯', b2: 'æˆŒ', element: 'ç«', requiredStems: ['ä¸™', 'ä¸', 'ç”²', 'ä¹™'] },
            { b1: 'è¾°', b2: 'é…‰', element: 'é‡‘', requiredStems: ['åºš', 'è¾›', 'æˆŠ', 'å·±'] },
            { b1: 'å·³', b2: 'ç”³', element: 'æ°´', requiredStems: ['å£¬', 'ç™¸', 'åºš', 'è¾›'] },
            { b1: 'åˆ', b2: 'æœª', element: 'ç«', requiredStems: ['ä¸™', 'ä¸', 'ç”²', 'ä¹™'] }
        ];

        const isShigoPair = (b1, b2) => {
            return shigoPairs.some(p => (p.b1 === b1 && p.b2 === b2) || (p.b1 === b2 && p.b2 === b1));
        };


        function checkKango(stems, branches) {
            let transformedStems = [...stems];
            let messages = [];

            const monthBranch = branches[1]; // æœˆæ”¯
            const isKangoMD = isKangoPair(stems[1], stems[2]); // æœˆå¹²-æ—¥å¹²
            const isKangoDH = isKangoPair(stems[2], stems[3]); // æ—¥å¹²-æ™‚å¹²

            // å¦¬åˆ check: æ—¥å¹²ãŒæœˆå¹²ã¨æ™‚å¹²ã«æŒŸã¾ã‚Œã‚‹
            if (isKangoMD && isKangoDH) {
                messages.push(`æ—¥å¹²ãŒæœˆå¹²ã¨æ™‚å¹²ã®ä¸¡æ–¹ã‹ã‚‰å¹²åˆã•ã‚Œã‚‹å¦¬åˆï¼ˆã¨ã†ã”ã†ï¼‰ã®ãŸã‚ã€å¹²åˆã¯å¤‰åŒ–ã—ã¾ã›ã‚“ã€‚`);
                return { transformedStems, messages }; // å¦¬åˆã®å ´åˆã¯ä»¥é™ã®å¹²åˆã¯æˆç«‹ã—ãªã„
            }

            let kangoedIndices = new Set();

            // æœˆå¹²-æ—¥å¹² ã®å¹²åˆã‚’ãƒã‚§ãƒƒã‚¯
            if (isKangoMD) {
                const sA = stems[1], sB = stems[2];
                let transformed = false;
                // ... (transformation logic remains the same)
                if ((sA === 'ç”²' && sB === 'å·±') || (sA === 'å·±' && sB === 'ç”²')) {
                    if (['åœŸ', 'ç«'].includes(branchElements[monthBranch])) {
                        transformedStems[stems.indexOf('ç”²')] = 'æˆŠ';
                        messages.push(`æœˆå¹²-æ—¥å¹²ã§ç”²å·±å¹²åˆãŒæˆç«‹ã—ã€åœŸã«å¤‰åŒ–ã—ã¾ã™ã€‚`);
                        transformed = true;
                    }
                } // ... other else-if blocks
                
                if (transformed) {
                    kangoedIndices.add(1); kangoedIndices.add(2);
                }
            }

            // æ—¥å¹²-æ™‚å¹² ã®å¹²åˆã‚’ãƒã‚§ãƒƒã‚¯ (æœˆå¹²-æ—¥å¹²ã§å¹²åˆã—ã¦ã„ãªã„å ´åˆã®ã¿)
            if (isKangoDH && !kangoedIndices.has(2)) {
                 const sA = stems[2], sB = stems[3];
                 let transformed = false;
                 // ... (transformation logic remains the same)
                if ((sA === 'ä¸™' && sB === 'è¾›') || (sA === 'è¾›' && sB === 'ä¸™')) {
                    if (['æ°´', 'é‡‘'].includes(branchElements[monthBranch]) || monthBranch === 'è¾°') {
                        transformedStems[stems.indexOf('ä¸™')] = 'å£¬';
                        transformedStems[stems.indexOf('è¾›')] = 'ç™¸';
                        messages.push(`æ—¥å¹²-æ™‚å¹²ã§ä¸™è¾›å¹²åˆãŒæˆç«‹ã—ã€æ°´ã«å¤‰åŒ–ã—ã¾ã™ã€‚`);
                        transformed = true;
                    }
                } // ... other else-if blocks
            }

            return { transformedStems, messages };
        }

        function checkShigo(stems, branches) {
            let strengthenedElement = null;
            let messages = [];
        
            const isShigoYM = isShigoPair(branches[0], branches[1]);
            const isShigoMD = isShigoPair(branches[1], branches[2]);
            const isShigoDH = isShigoPair(branches[2], branches[3]);
        
            const monthIsTogo = isShigoYM && isShigoMD;
            const dayIsTogo = isShigoMD && isShigoDH;
        
            const checks = [
                { key: 'YM', isValid: isShigoYM && !monthIsTogo, idxA: 0, idxB: 1, info: 'å¹´æ”¯-æœˆæ”¯' },
                { key: 'MD', isValid: isShigoMD && !monthIsTogo && !dayIsTogo, idxA: 1, idxB: 2, info: 'æœˆæ”¯-æ—¥æ”¯' },
                { key: 'DH', isValid: isShigoDH && !dayIsTogo, idxA: 2, idxB: 3, info: 'æ—¥æ”¯-æ™‚æ”¯' }
            ];

            if (monthIsTogo) messages.push(`æœˆæ”¯ãŒå¹´æ”¯ã¨æ—¥æ”¯ã«æŒŸã¾ã‚Œã‚‹å¦¬åˆã®ãŸã‚ã€å¹´æ”¯-æœˆæ”¯ã¨æœˆæ”¯-æ—¥æ”¯ã®æ”¯åˆã¯å¤‰åŒ–ã—ã¾ã›ã‚“ã€‚`);
            if (dayIsTogo && !monthIsTogo) messages.push(`æ—¥æ”¯ãŒæœˆæ”¯ã¨æ™‚æ”¯ã«æŒŸã¾ã‚Œã‚‹å¦¬åˆã®ãŸã‚ã€æœˆæ”¯-æ—¥æ”¯ã¨æ—¥æ”¯-æ™‚æ”¯ã®æ”¯åˆã¯å¤‰åŒ–ã—ã¾ã›ã‚“ã€‚`);

            for (const check of checks) {
                if (!check.isValid) continue;
        
                const bA = branches[check.idxA], bB = branches[check.idxB];
                const sA = stems[check.idxA], sB = stems[check.idxB];
        
                const prevBranch = branches[check.idxA - 1];
                const nextBranch = branches[check.idxB + 1];
                if ((prevBranch && isShichuPair(bA, prevBranch)) || (nextBranch && isShichuPair(bB, nextBranch))) {
                    messages.push(`${check.info}ã§${bA}${bB}ã®æ”¯åˆãŒã‚ã‚Šã¾ã™ãŒã€éš£æ¥ã™ã‚‹åœ°æ”¯ã¨æ”¯å†²ãŒæˆç«‹ã™ã‚‹ãŸã‚å¤‰åŒ–ã—ã¾ã›ã‚“ã€‚`);
                    continue;
                }
        
                if (isKangoPair(sA, sB)) {
                    messages.push(`${check.info}ã§${bA}${bB}ã®æ”¯åˆãŒã‚ã‚Šã¾ã™ãŒã€å¤©å¹²ãŒå¹²åˆã—ã¦ã„ã‚‹ãŸã‚å¤‰åŒ–ã—ã¾ã›ã‚“ã€‚`);
                    continue;
                }
        
                const pairInfo = shigoPairs.find(p => (p.b1 === bA && p.b2 === bB) || (p.b1 === bB && p.b2 === bA));
                if (pairInfo && (pairInfo.requiredStems.includes(sA) || pairInfo.requiredStems.includes(sB))) {
                    strengthenedElement = pairInfo.element;
                    messages.push(`${check.info}ã§${bA}${bB}æ”¯åˆãŒæˆç«‹ã—ã€${pairInfo.element}ã®åŠ›é‡ãŒå¼·ã¾ã‚Šã¾ã™ã€‚`);
                    break; 
                } else if (pairInfo) {
                     messages.push(`${check.info}ã§${bA}${bB}æ”¯åˆãŒã‚ã‚Šã¾ã™ãŒã€å¤‰åŒ–ã®æ¡ä»¶ã‚’æº€ãŸã•ãªã„ãŸã‚åŠ›é‡ã¯å¤‰åŒ–ã—ã¾ã›ã‚“ã€‚`);
                }
            }
        
            return { strengthenedElement, messages };
        }
        
        // --- End of Kango/Shigo Logic ---


        function updateAnalysis() {
            let stemsUI = [
                document.getElementById('hourStem').value,
                document.getElementById('dayStem').value,
                document.getElementById('monthStem').value,
                document.getElementById('yearStem').value
            ];
            let branchesUI = [
                document.getElementById('hourBranch').value,
                document.getElementById('dayBranch').value,
                document.getElementById('monthBranch').value,
                document.getElementById('yearBranch').value
            ];
            
            if (stemsUI.includes('') || branchesUI.includes('')) return;
            
            // Order for analysis functions is [year, month, day, hour]
            const sortedStems = [stemsUI[3], stemsUI[2], stemsUI[1], stemsUI[0]];
            const sortedBranches = [branchesUI[3], branchesUI[2], branchesUI[1], branchesUI[0]];

            // Check for transformations based on original chart
            // Note: Kango should be checked before Shigo as Shigo depends on final stem values
            const kangoResult = checkKango(sortedStems, sortedBranches);
            let transformedStems = kangoResult.transformedStems;
            const shigoResult = checkShigo(transformedStems, sortedBranches);


            // Update UI selects if stems were transformed by Kango
            if (JSON.stringify(transformedStems) !== JSON.stringify(sortedStems)) {
                document.getElementById('yearStem').value = transformedStems[0];
                document.getElementById('monthStem').value = transformedStems[1];
                document.getElementById('dayStem').value = transformedStems[2];
                document.getElementById('hourStem').value = transformedStems[3];
            }
            
            const dayStem = transformedStems[2];
            if (!dayStem) return;

            // Display Zokan (è”µå¹²)
            document.getElementById('hourHidden').textContent = hiddenStemsPriority[sortedBranches[3]]?.join('ãƒ»') || '';
            document.getElementById('dayHidden').textContent = hiddenStemsPriority[sortedBranches[2]]?.join('ãƒ»') || '';
            document.getElementById('monthHidden').textContent = hiddenStemsPriority[sortedBranches[1]]?.join('ãƒ»') || '';
            document.getElementById('yearHidden').textContent = hiddenStemsPriority[sortedBranches[0]]?.join('ãƒ»') || '';

            // Display Tsuhensei for Zokan (è”µå¹²é€šå¤‰æ˜Ÿ)
            const hiddenGods = [sortedBranches[3], sortedBranches[2], sortedBranches[1], sortedBranches[0]].map(branch => {
                const hidden = hiddenStemsPriority[branch];
                return hidden ? hidden.map(hStem => getTenGod(dayStem, hStem)).join('ãƒ»') : '';
            });
            // Order is hour, day, month, year for display
            document.getElementById('hourHiddenGod').textContent = hiddenGods[3];
            document.getElementById('dayHiddenGod').textContent = hiddenGods[2];
            document.getElementById('monthHiddenGod').textContent = hiddenGods[1];
            document.getElementById('yearHiddenGod').textContent = hiddenGods[0];


            // Display Tsuhensei for Tenkan (å¤©å¹²é€šå¤‰æ˜Ÿ)
            document.getElementById('hourGod').textContent = getTenGod(dayStem, transformedStems[3]);
            document.getElementById('monthGod').textContent = getTenGod(dayStem, transformedStems[1]);
            document.getElementById('yearGod').textContent = getTenGod(dayStem, transformedStems[0]);

            // Display 12 Un (åäºŒé‹)
            document.getElementById('hour12').textContent = getTwelveStage(transformedStems[3], sortedBranches[3]);
            document.getElementById('day12').textContent = getTwelveStage(transformedStems[2], sortedBranches[2]);
            document.getElementById('month12').textContent = getTwelveStage(transformedStems[1], sortedBranches[1]);
            document.getElementById('year12').textContent = getTwelveStage(transformedStems[0], sortedBranches[0]);
            
            analyzeDestiny(dayStem, transformedStems, sortedBranches, kangoResult.messages, shigoResult);
            
            if (window.currentGender && window.currentBirthDate) calculateDaiunn();
        }
        
        function getSpecialKakkyoku(strengthResult, dayStem, stems, branches) {
            const allStemsForGods = [];
            allStemsForGods.push(stems[0], stems[1], stems[3]); 
            
            branches.forEach(b => {
                if (hiddenStemsPriority[b]) {
                    allStemsForGods.push(...hiddenStemsPriority[b]);
                }
            });

            const tenGods = allStemsForGods.map(s => getTenGod(dayStem, s)).filter(g => g);

            if (strengthResult.includes('æ¥µèº«å¼·')) {
                const juoCount = tenGods.filter(g => g === 'æ¯”è‚©' || g === 'åŠ«è²¡').length;
                const jukyoCount = tenGods.filter(g => g === 'åå°' || g === 'å°ç¶¬').length;

                if (juoCount >= jukyoCount) {
                    return 'å¾“æ—ºæ ¼';
                } else {
                    return 'å¾“å¼·æ ¼';
                }
            }

            if (strengthResult.includes('æ¥µèº«å¼±')) {
                const jujiCount = tenGods.filter(g => g === 'é£Ÿç¥' || g === 'å‚·å®˜').length;
                const juzaiCount = tenGods.filter(g => g === 'åè²¡' || g === 'æ­£è²¡').length;
                const jusatsuCount = tenGods.filter(g => g === 'åå®˜' || g === 'æ­£å®˜').length;
                
                if (jujiCount > 0 && juzaiCount > 0 && jusatsuCount > 0) {
                     return 'å¾“å‹¢æ ¼';
                }

                const maxCount = Math.max(jujiCount, juzaiCount, jusatsuCount);
                if (maxCount === 0) return 'ç‰¹åˆ¥æ ¼å±€ï¼ˆåˆ†é¡ä¸èƒ½ï¼‰';
                if (maxCount === jujiCount) return 'å¾“å…æ ¼';
                if (maxCount === juzaiCount) return 'å¾“è²¡æ ¼';
                if (maxCount === jusatsuCount) return 'å¾“æ®ºæ ¼';
            }
            
            return 'ç‰¹åˆ¥æ ¼å±€ï¼ˆåˆ¤å®šä¸èƒ½ï¼‰';
        }

        function getNormalKakkyoku(dayStem, stems, branches, birthDate) {
            const yearStem = stems[0], monthStem = stems[1], hourStem = stems[3];
            const monthBranch = branches[1];

            const kenrokuConditions = { 'ç”²': 'å¯…', 'ä¹™': 'å¯', 'ä¸™': 'å·³', 'ä¸': 'åˆ', 'æˆŠ': 'å·³', 'å·±': 'åˆ', 'åºš': 'ç”³', 'è¾›': 'é…‰', 'å£¬': 'äº¥', 'ç™¸': 'å­' };
            if (kenrokuConditions[dayStem] === monthBranch) return 'å»ºç¦„æ ¼';
            const getsurinConditions = { 'ç”²': 'å¯', 'ä¸™': 'åˆ', 'æˆŠ': 'åˆ', 'åºš': 'é…‰', 'å£¬': 'å­' };
            if (getsurinConditions[dayStem] === monthBranch) return 'æœˆåˆƒæ ¼';

            const monthHiddenStems = hiddenStemsPriority[monthBranch];
            if (!monthHiddenStems) return 'åˆ¤å®šä¸èƒ½';

            const getElement = (stem) => stem ? stemElements[stem] : null;
            
            const findKakkyokuFromHidden = (hiddenStem) => {
                const god = getTenGod(dayStem, hiddenStem);
                if (god === 'æ¯”è‚©') return 'å»ºç¦„æ ¼';
                if (god === 'åŠ«è²¡') return 'æœˆåˆƒæ ¼';
                return god ? god + 'æ ¼' : 'åˆ¤å®šä¸èƒ½';
            };

            if (monthStem) {
                for (const hidden of monthHiddenStems) {
                    if (getElement(hidden) === getElement(monthStem)) return findKakkyokuFromHidden(hidden);
                }
            }
            
            let foundInYearHour = null;
            for (const hidden of monthHiddenStems) {
                 if ((yearStem && getElement(hidden) === getElement(yearStem)) || (hourStem && getElement(hidden) === getElement(hourStem))) {
                    foundInYearHour = hidden;
                    break;
                 }
            }
            if(foundInYearHour) return findKakkyokuFromHidden(foundInYearHour);
            
            const year = birthDate.getFullYear(), month = birthDate.getMonth() + 1, day = birthDate.getDate();
            let astroYear = year, astroMonth = month;
            let currentSetsuiri = getSetsuiriDate(astroYear, astroMonth);
            
            if(day < currentSetsuiri.day) {
                astroMonth = month === 1 ? 12 : month - 1;
                if (month === 1) astroYear--;
                currentSetsuiri = getSetsuiriDate(astroYear, astroMonth);
            }
            
            const daysPassed = day - currentSetsuiri.day + 1;
            const shinsenhyoRules = shinsenhyo[monthBranch];
            
            if(shinsenhyoRules){
                for(const rule of shinsenhyoRules){
                    if(daysPassed <= rule.days){
                        const chosenStem = rule.stem;
                        return findKakkyokuFromHidden(chosenStem);
                    }
                }
            }

            return 'åˆ¤å®šä¸èƒ½';
        }

        function analyzeDestiny(dayStem, stems, branches, kangoMessages, shigoResult) {
            const elementCount = {'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0};
            stems.forEach(stem => {
                if (stem) elementCount[stemElements[stem]]++;
            });
            branches.forEach(branch => {
                if (branch) elementCount[branchElements[branch]]++;
            });

            // Reflect Shigo result on element balance
            if (shigoResult.strengthenedElement) {
                elementCount[shigoResult.strengthenedElement] += 2; // Add weight to the strengthened element
            }

            const dayElement = stemElements[dayStem];
            const dayYinYang = stemYinYang[dayStem];
            const strength = judgeStrength(dayStem, stems, branches);
            
            let kakkyoku;
            if (strength.includes('æ¥µèº«å¼·') || strength.includes('æ¥µèº«å¼±')) {
                kakkyoku = getSpecialKakkyoku(strength, dayStem, stems, branches);
            } else {
                kakkyoku = getNormalKakkyoku(dayStem, stems, branches, window.currentBirthDate);
            }
            
            const kakkyokuInfo = kakkyokuDescriptions[kakkyoku] || { title: 'åˆ¤å®šä¸èƒ½', description: 'ã‚ãªãŸã®ä¾¡å€¤è¦³ã®æºã¨ãªã‚‹æ ¼å±€ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚' };

            let transformationHTML = '';
            const allMessages = [...kangoMessages, ...shigoResult.messages].filter((v, i, a) => a.indexOf(v) === i); // Unique messages
            if (allMessages.length > 0) {
                transformationHTML += `<div class="analysis-item">
                    <div class="analysis-title">å‘½å¼ã®å¤‰åŒ–</div>`;
                 allMessages.forEach(msg => {
                    const type = msg.includes("å¹²åˆ") ? "ã€å¹²åˆã€‘" : "ã€æ”¯åˆã€‘";
                    transformationHTML += `<div><span class="transformed">${type}</span>${msg}</div>`;
                 });
                transformationHTML += `</div>`;
            }

            let analysisHTML = transformationHTML + `
                <div class="analysis-item">
                    <div class="analysis-title">æ—¥ä¸»ï¼ˆã‚ãªãŸã®æœ¬è³ªï¼‰</div>
                    <div>${dayStem}ï¼ˆ${dayYinYang}ã®${dayElement}ï¼‰</div>
                    <div>${getDayStemDescription(dayStem)}</div>
                </div>
                 <div class="analysis-item">
                    <div class="analysis-title">æ ¼å±€ï¼ˆã‚ãªãŸã®ä¾¡å€¤è¦³ï¼‰</div>
                    <div><strong>${kakkyoku}</strong>ï¼š${kakkyokuInfo.title}</div>
                    <div style="margin-top: 8px; line-height: 1.6;">${kakkyokuInfo.description}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-title">äº”è¡Œãƒãƒ©ãƒ³ã‚¹</div>
                    <div class="element-balance">
                        <div class="element-bar wood">æœ¨: ${elementCount['æœ¨']}</div>
                        <div class="element-bar fire">ç«: ${elementCount['ç«']}</div>
                        <div class="element-bar earth">åœŸ: ${elementCount['åœŸ']}</div>
                        <div class="element-bar metal">é‡‘: ${elementCount['é‡‘']}</div>
                        <div class="element-bar water">æ°´: ${elementCount['æ°´']}</div>
                    </div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-title">èº«å¼·ãƒ»èº«å¼±åˆ¤å®š</div>
                    <div>${strength}</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-title">ç·åˆé‹å‹¢</div>
                    <div style="line-height: 1.6;">${getOverallFortune(dayStem, strength, elementCount)}</div>
                </div>`;
            document.getElementById('analysisResult').innerHTML = analysisHTML;
        }

        function judgeStrength(dayStem, stems, branches) {
            if (!dayStem || branches.some(b => !b) || stems.some(s => !s)) {
                return 'å‘½å¼ãŒä¸å®Œå…¨ãªãŸã‚åˆ¤å®šã§ãã¾ã›ã‚“ã€‚';
            }

            const elementCycle = ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'];
            const getElement = (name) => {
                const stemEl = stemElements[name];
                if (stemEl) return stemEl;
                const branchEl = branchElements[name];
                if (branchEl) return branchEl;
                return null;
            };

            const dayElement = getElement(dayStem);
            const monthBranch = branches[1];
            const monthElement = getElement(monthBranch);

            const getRelationship = (baseEl, targetEl) => {
                if (!baseEl || !targetEl) return 'none';
                if (baseEl === targetEl) return 'same';
                const baseIndex = elementCycle.indexOf(baseEl);
                const targetIndex = elementCycle.indexOf(targetEl);
                if ((baseIndex + 1) % 5 === targetIndex) return 'produces';
                if ((baseIndex + 2) % 5 === targetIndex) return 'attacks';
                if ((baseIndex + 3) % 5 === targetIndex) return 'attacked_by';
                if ((baseIndex + 4) % 5 === targetIndex) return 'produced_by';
                return 'none';
            };
            
            const isTokurei = ['same', 'produced_by'].includes(getRelationship(dayElement, monthElement));
            const tokuchiCount = [branches[0], branches[2], branches[3]].filter(b => ['same', 'produced_by'].includes(getRelationship(dayElement, getElement(b)))).length;
            const tokujoCount = [stems[0], stems[1], stems[3]].filter(s => ['same', 'produced_by'].includes(getRelationship(dayElement, getElement(s)))).length;
            
            const isShitsurei = ['produces', 'attacks', 'attacked_by'].includes(getRelationship(dayElement, monthElement));
            const weakeningStems = [stems[0], stems[1], stems[3]].filter(s => ['produces', 'attacks', 'attacked_by'].includes(getRelationship(dayElement, getElement(s)))).length;
            const weakeningBranches = [branches[0], branches[2], branches[3]].filter(b => ['produces', 'attacks', 'attacked_by'].includes(getRelationship(dayElement, getElement(b)))).length;

            if (isTokurei && tokujoCount >= 2 && tokuchiCount >= 2) {
                return 'æ¥µèº«å¼·ï¼šæ—¥ä¸»ã®åŠ›ãŒæ¥µã‚ã¦å¼·ãã€éå¸¸ã«å¤§ããªã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æŒã£ã¦ã„ã¾ã™ã€‚è‡ªå·±ã®æ„å¿—ã‚’è²«ãå¼·ã•ãŒã‚ã‚Šã¾ã™ãŒã€å¼·å¼•ã«ãªã‚Šã™ããªã„ã‚ˆã†å‘¨å›²ã¨ã®èª¿å’Œã‚’æ„è­˜ã™ã‚‹ã“ã¨ãŒæˆåŠŸã®éµã§ã™ã€‚';
            }
            if (isShitsurei && weakeningStems >= 2 && (weakeningBranches-1) >= 3) {
                return 'æ¥µèº«å¼±ï¼šæ—¥ä¸»ã®åŠ›ãŒæ¥µã‚ã¦å¼±ãã€ç¹Šç´°ã§å‘¨å›²ã®å½±éŸ¿ã‚’å—ã‘ã‚„ã™ã„ã§ã™ã€‚è‡ªåˆ†ã‚’æ”¯ãˆã¦ãã‚Œã‚‹ç’°å¢ƒã‚„äººé–“é–¢ä¿‚ã‚’ä½•ã‚ˆã‚Šã‚‚å¤§åˆ‡ã«ã€‚ç„¡ç†ã‚’ã›ãšã€è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§ç€å®Ÿã«é€²ã‚€ã“ã¨ã§æ‰èƒ½ãŒé–‹èŠ±ã—ã¾ã™ã€‚';
            }

            const checkKaikyoku = () => {
                const branchSet = new Set(branches);
                const combinations = [
                    { name: 'ä¸‰æ–¹æœ¨å±€', branches: ['å¯…', 'å¯', 'è¾°'], element: 'æœ¨' }, { name: 'ä¸‰æ–¹ç«å±€', branches: ['å·³', 'åˆ', 'æœª'], element: 'ç«' },
                    { name: 'ä¸‰æ–¹é‡‘å±€', branches: ['ç”³', 'é…‰', 'æˆŒ'], element: 'é‡‘' }, { name: 'ä¸‰æ–¹æ°´å±€', branches: ['äº¥', 'å­', 'ä¸‘'], element: 'æ°´' },
                    { name: 'ä¸‰åˆæœ¨å±€', branches: ['äº¥', 'å¯', 'æœª'], element: 'æœ¨' }, { name: 'ä¸‰åˆç«å±€', branches: ['å¯…', 'åˆ', 'æˆŒ'], element: 'ç«' },
                    { name: 'ä¸‰åˆé‡‘å±€', branches: ['å·³', 'é…‰', 'ä¸‘'], element: 'é‡‘' }, { name: 'ä¸‰åˆæ°´å±€', branches: ['ç”³', 'å­', 'è¾°'], element: 'æ°´' },
                ];
                for (const comb of combinations) {
                    if (comb.branches.every(b => branchSet.has(b))) return { found: true, element: comb.element, includesMonthBranch: comb.branches.includes(monthBranch) };
                }
                return { found: false };
            };
            const kaikyokuResult = checkKaikyoku();

            let isMikyo = false;
            const conditionsMet = [isTokurei, tokuchiCount > 0, tokujoCount > 0];
            const numConditionsMet = conditionsMet.filter(Boolean).length;
            
            if (numConditionsMet >= 2) {
                if (!conditionsMet[0] && conditionsMet[1] && conditionsMet[2]) { 
                    if (tokuchiCount + tokujoCount >= 3) isMikyo = true;
                } else {
                    isMikyo = true;
                }
            }
            if (!isMikyo && kaikyokuResult.found && ['same', 'produced_by'].includes(getRelationship(dayElement, kaikyokuResult.element)) && (kaikyokuResult.includesMonthBranch || (!kaikyokuResult.includesMonthBranch && isTokurei))) isMikyo = true;
            
            if (isMikyo) return 'èº«å¼·ï¼šæ—¥ä¸»ã®åŠ›ãŒå¼·ãã€è¡Œå‹•åŠ›ã¨è‡ªå·±è‚¯å®šæ„ŸãŒé«˜ã„ã‚¿ã‚¤ãƒ—ã§ã™ã€‚ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã§ãã¾ã™ãŒã€æ™‚ã«ã¯ä»–è€…ã®æ„è¦‹ã«è€³ã‚’å‚¾ã‘ã‚‹æŸ”è»Ÿæ€§ã‚‚æŒã¤ã“ã¨ã§ã€ã‚ˆã‚Šå¤§ããªæˆåŠŸã‚’æ´ã‚ã¾ã™ã€‚';
            return 'èº«å¼±ï¼šå”èª¿æ€§ãŒã‚ã‚Šã€å‘¨å›²ã®çŠ¶æ³ã«åˆã‚ã›ã¦æŸ”è»Ÿã«å¯¾å¿œã§ãã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚ã‚µãƒãƒ¼ãƒˆå½¹ã‚„ãƒãƒ¼ãƒ ã§å‹•ãã“ã¨ã§åŠ›ã‚’ç™ºæ®ã—ã¾ã™ã€‚è‡ªä¿¡ã‚’æŒã¡ã€ä¿¡é ¼ã§ãã‚‹ä»²é–“ã¨ã®é€£æºã‚’å¤§åˆ‡ã«ã—ã¾ã—ã‚‡ã†ã€‚';
        }

        function getDayStemDescription(stem) {
            const descriptions = {
                'ç”²': 'å¤§æ¨¹ã®ã‚ˆã†ãªå­˜åœ¨æ„ŸãŒã‚ã‚Šã€ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚æ­£ç›´ã§çœŸã£ç›´ããªæ€§æ ¼ã§ã™ã€‚', 'ä¹™': 'è‰èŠ±ã®ã‚ˆã†ãªæŸ”è»Ÿæ€§ãŒã‚ã‚Šã€å”èª¿æ€§ã«å¯Œã‚“ã§ã„ã¾ã™ã€‚ç¹Šç´°ã§ç¾çš„æ„Ÿè¦šã«å„ªã‚Œã¦ã„ã¾ã™ã€‚',
                'ä¸™': 'å¤ªé™½ã®ã‚ˆã†ãªæ˜ã‚‹ã•ãŒã‚ã‚Šã€æƒ…ç†±çš„ã§è¡Œå‹•åŠ›ãŒã‚ã‚Šã¾ã™ã€‚äººã‚’æƒ¹ãã¤ã‘ã‚‹é­…åŠ›ãŒã‚ã‚Šã¾ã™ã€‚', 'ä¸': 'ã‚ã†ããã®ç«ã®ã‚ˆã†ãªå„ªã—ã„å…‰ã§ã€å‘¨å›²ã‚’æ¸©ã‹ãç…§ã‚‰ã—ã¾ã™ã€‚æ€æ…®æ·±ãçŒ®èº«çš„ã§ã™ã€‚',
                'æˆŠ': 'å±±ã®ã‚ˆã†ã«ã©ã£ã—ã‚Šã¨ã—ãŸå®‰å®šæ„ŸãŒã‚ã‚Šã€ä¿¡é ¼ã•ã‚Œã‚‹å­˜åœ¨ã§ã™ã€‚åŒ…å®¹åŠ›ãŒã‚ã‚Šã¾ã™ã€‚', 'å·±': 'å¤§åœ°ã®ã‚ˆã†ãªæ¯æ€§çš„ãªå„ªã—ã•ãŒã‚ã‚Šã€è‚²ã‚€åŠ›ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚å …å®Ÿã§çœŸé¢ç›®ã§ã™ã€‚',
                'åºš': 'åˆ€å‰£ã®ã‚ˆã†ãªé‹­ã•ãŒã‚ã‚Šã€æ±ºæ–­åŠ›ã¨å®Ÿè¡ŒåŠ›ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚æ­£ç¾©æ„ŸãŒå¼·ã„ã§ã™ã€‚', 'è¾›': 'å®çŸ³ã®ã‚ˆã†ãªç¹Šç´°ã•ã¨ç¾ã—ã•ãŒã‚ã‚Šã€ã‚»ãƒ³ã‚¹ã¨æ„Ÿæ€§ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚å®Œç’§ä¸»ç¾©çš„ã§ã™ã€‚',
                'å£¬': 'å¤§æµ·ã®ã‚ˆã†ãªåŒ…å®¹åŠ›ãŒã‚ã‚Šã€çŸ¥è­˜æ¬²æ—ºç››ã§é©å¿œåŠ›ãŒã‚ã‚Šã¾ã™ã€‚è‡ªç”±ã‚’æ„›ã—ã¾ã™ã€‚', 'ç™¸': 'é›¨éœ²ã®ã‚ˆã†ãªæ½¤ã„ã‚’ä¸ãˆã‚‹å­˜åœ¨ã§ã€çŸ¥æµã¨ç›´æ„ŸåŠ›ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚ç¥ç§˜çš„ãªé­…åŠ›ãŒã‚ã‚Šã¾ã™ã€‚'
            };
            return descriptions[stem] || '';
        }

        function getOverallFortune(dayStem, strength, elementCount) {
            let fortune = `ã‚ãªãŸã¯${dayStem}ã®ç”Ÿã¾ã‚Œã§ã€${stemElements[dayStem]}ã®æ€§è³ªã‚’æŒã£ã¦ã„ã¾ã™ã€‚`;
            if (strength.includes('æ¥µèº«å¼·')) fortune += 'éå¸¸ã«å¼·ã„ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨å®Ÿè¡ŒåŠ›ã‚’æŒã¡ã€å›°é›£ãªçŠ¶æ³ã§ã‚‚çªç ´ã§ãã‚‹åŠ›ãŒã‚ã‚Šã¾ã™ã€‚ãã®å¼·å¤§ãªåŠ›ã‚’ç¤¾ä¼šè²¢çŒ®ã‚„å‰µé€ çš„ãªæ´»å‹•ã«å‘ã‘ã‚‹ã“ã¨ã§ã€å¤§ããªæˆåŠŸã‚’åã‚ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚è¬™è™šã•ã¨æŸ”è»Ÿæ€§ã‚’å¿˜ã‚Œãšã«ã€å‘¨å›²ã¨ã®èª¿å’Œã‚’ä¿ã¤ã“ã¨ãŒé•·æœŸçš„ãªæˆåŠŸã®éµã¨ãªã‚Šã¾ã™ã€‚';
            else if (strength.includes('èº«å¼·')) fortune += 'å¼·ã„å€‹æ€§ã¨å®Ÿè¡ŒåŠ›ã‚’æŒã£ã¦ã„ã‚‹ãŸã‚ã€ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã™ã‚‹å ´é¢ã§æ´»èºã§ãã‚‹ã§ã—ã‚‡ã†ã€‚æ™‚ã«ã¯å‘¨å›²ã®æ„è¦‹ã«è€³ã‚’å‚¾ã‘ã€æŸ”è»Ÿæ€§ã‚’æŒã¤ã“ã¨ã§ã•ã‚‰ãªã‚‹æˆé•·ãŒæœŸå¾…ã§ãã¾ã™ã€‚';
            else if (strength.includes('èº«å¼±')) fortune += 'å”èª¿æ€§ã¨é©å¿œåŠ›ã«å„ªã‚Œã€ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã§æˆåŠŸã‚’åã‚ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚è‡ªåˆ†ã‚’æ”¯ãˆã¦ãã‚Œã‚‹äººé–“é–¢ä¿‚ã‚’å¤§åˆ‡ã«ã—ã€è‡ªä¿¡ã‚’æŒã£ã¦è¡Œå‹•ã™ã‚‹ã“ã¨ãŒé–‹é‹ã®éµã¨ãªã‚Šã¾ã™ã€‚';
            else if (strength.includes('æ¥µèº«å¼±')) fortune += 'ç¹Šç´°ãªæ„Ÿå—æ€§ã¨æ´å¯ŸåŠ›ã‚’æŒã¡ã€äººã®æ°—æŒã¡ã‚’ç†è§£ã™ã‚‹èƒ½åŠ›ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚ã‚µãƒãƒ¼ã‚¿ãƒ¼çš„ãªç«‹å ´ã§åŠ›ã‚’ç™ºæ®ã—ã€å”åŠ›çš„ãªç’°å¢ƒã§æ‰èƒ½ãŒé–‹èŠ±ã—ã¾ã™ã€‚ç„¡ç†ã‚’ã›ãšè‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã‚’å¤§åˆ‡ã«ã—ã€ä¿¡é ¼ã§ãã‚‹ä»²é–“ã¨å…±ã«æ­©ã‚€ã“ã¨ã§å¹¸é‹ã‚’å¼•ãå¯„ã›ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚';
            
            const minElement = Object.keys(elementCount).reduce((a, b) => elementCount[a] < elementCount[b] ? a : b);
            const elementAdvice = {
                'æœ¨': 'ç·‘è‰²ã®ã‚‚ã®ã‚’èº«ã«ã¤ã‘ãŸã‚Šã€è¦³è‘‰æ¤ç‰©ã‚’è‚²ã¦ã‚‹ã“ã¨ã§é‹æ°—ãŒä¸Šæ˜‡ã—ã¾ã™ã€‚', 'ç«': 'èµ¤è‰²ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–ã‚Šå…¥ã‚ŒãŸã‚Šã€å¤ªé™½ã®å…‰ã‚’æµ´ã³ã‚‹ã“ã¨ã§æ´»åŠ›ãŒå¢—ã—ã¾ã™ã€‚',
                'åœŸ': 'é»„è‰²ã‚„èŒ¶è‰²ã‚’æ„è­˜ã—ã€å¤§åœ°ã«è§¦ã‚Œã‚‹æ©Ÿä¼šã‚’å¢—ã‚„ã™ã¨å®‰å®šæ„ŸãŒå¢—ã—ã¾ã™ã€‚', 'é‡‘': 'ç™½è‰²ã‚„é‡‘å±è£½ã®ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ã§æ±ºæ–­åŠ›ãŒé«˜ã¾ã‚Šã¾ã™ã€‚',
                'æ°´': 'é’è‰²ã‚„é»’è‰²ã‚’å–ã‚Šå…¥ã‚Œã€æ°´è¾ºã§éã”ã™æ™‚é–“ã‚’ä½œã‚‹ã¨çŸ¥æµãŒæ·±ã¾ã‚Šã¾ã™ã€‚'
            };
            fortune += `<br><br><strong>ã€é–‹é‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘</strong><br>${elementAdvice[minElement]}`;
            return fortune;
        }

        function calculateDaiunn() {
            const yearStem = document.getElementById('yearStem').value;
            const monthStem = document.getElementById('monthStem').value;
            const monthBranch = document.getElementById('monthBranch').value;
            const dayStem = document.getElementById('dayStem').value;
            if (!yearStem || !monthStem || !monthBranch || !window.currentGender || !window.currentBirthDate) return;
            
            const gender = window.currentGender;
            const birthDateWithTime = window.currentBirthDate;
            const yearStemIndex = heavenlyStems.indexOf(yearStem);
            const isYangYear = yearStemIndex % 2 === 0;
            const isForward = (isYangYear && gender === 'male') || (!isYangYear && gender === 'female');
            
            const year = birthDateWithTime.getFullYear(), month = birthDateWithTime.getMonth() + 1;
            let daysDiff = 0;
            let setsuiriDateForCalc;

            if (isForward) {
                const currentMonthSetsuiri = getSetsuiriDate(year, month);
                if (birthDateWithTime.getDate() >= currentMonthSetsuiri.day) {
                    const nextMonth = month === 12 ? 1 : month + 1;
                    const nextYear = month === 12 ? year + 1 : year;
                    const nextSetsuiri = getSetsuiriDate(nextYear, nextMonth);
                    setsuiriDateForCalc = new Date(nextYear, nextMonth - 1, nextSetsuiri.day);
                } else {
                    setsuiriDateForCalc = new Date(year, month - 1, currentMonthSetsuiri.day);
                }
                daysDiff = (setsuiriDateForCalc.getTime() - birthDateWithTime.getTime()) / (1000 * 60 * 60 * 24);
            } else {
                const currentMonthSetsuiri = getSetsuiriDate(year, month);
                if (birthDateWithTime.getDate() < currentMonthSetsuiri.day) {
                    const prevMonth = month === 1 ? 12 : month - 1;
                    const prevYear = month === 1 ? year - 1 : year;
                    const prevSetsuiri = getSetsuiriDate(prevYear, prevMonth);
                    setsuiriDateForCalc = new Date(prevYear, prevMonth - 1, prevSetsuiri.day);
                } else {
                    setsuiriDateForCalc = new Date(year, month - 1, currentMonthSetsuiri.day);
                }
                daysDiff = (birthDateWithTime.getTime() - setsuiriDateForCalc.getTime()) / (1000 * 60 * 60 * 24);
            }
            
            const startAge = Math.max(1, Math.round(daysDiff / 3));
            const monthStemIndex = heavenlyStems.indexOf(monthStem);
            const monthBranchIndex = earthlyBranches.indexOf(monthBranch);
            
            let daiunnHTML = '<table class="daiunn-table"><tr><th>å¹´é½¢</th><th>å¤§é‹å¤©å¹²</th><th>å¤§é‹åœ°æ”¯</th><th>é€šå¤‰æ˜Ÿ</th><th>é‹å‹¢å‚¾å‘</th></tr>';
            for (let i = 0; i < 8; i++) {
                const age = startAge + (i * 10);
                const stemIndex = isForward ? (monthStemIndex + i + 1) % 10 : (monthStemIndex - i - 1 + 100) % 10;
                const branchIndex = isForward ? (monthBranchIndex + i + 1) % 12 : (monthBranchIndex - i - 1 + 120) % 12;
                const daiunnStem = heavenlyStems[stemIndex];
                const daiunnBranch = earthlyBranches[branchIndex];
                const tenGod = getTenGod(dayStem, daiunnStem);
                const fortune = getDaiunnFortune(tenGod);
                daiunnHTML += `<tr><td>${age}æ­³ï½${age+9}æ­³</td><td>${daiunnStem}</td><td>${daiunnBranch}</td><td>${tenGod}</td><td>${fortune}</td></tr>`;
            }
            daiunnHTML += '</table>';
            
            document.getElementById('daiunnResult').innerHTML = daiunnHTML;
            document.getElementById('daiunnSection').style.display = 'block';
        }

        function getDaiunnFortune(tenGod) {
            const fortunes = {
                'æ¯”è‚©': 'ç‹¬ç«‹å¿ƒãŒå¼·ã¾ã‚Šã€è‡ªåˆ†ã®é“ã‚’åˆ‡ã‚Šé–‹ãæ™‚æœŸ', 'åŠ«è²¡': 'å”åŠ›è€…ã¨ã®å‡ºä¼šã„ã€ç«¶äº‰å¿ƒãŒé«˜ã¾ã‚‹æ™‚æœŸ',
                'é£Ÿç¥': 'æ‰èƒ½é–‹èŠ±ã€æ¥½ã—ã¿ã‚„è¶£å‘³ãŒå……å®Ÿã™ã‚‹æ™‚æœŸ', 'å‚·å®˜': 'å‰µé€ æ€§ç™ºæ®ã€å¤‰é©ã‚„æŒ‘æˆ¦ã®æ™‚æœŸ',
                'æ­£è²¡': 'çµŒæ¸ˆçš„å®‰å®šã€å …å®Ÿãªæˆæœã‚’å¾—ã‚‹æ™‚æœŸ', 'åè²¡': 'è‡¨æ™‚åå…¥ã€ãƒãƒ£ãƒ³ã‚¹ã‚„å¹¸é‹ã«æµã¾ã‚Œã‚‹æ™‚æœŸ',
                'æ­£å®˜': 'ç¤¾ä¼šçš„åœ°ä½å‘ä¸Šã€è²¬ä»»ã‚ã‚‹ç«‹å ´ã«ã¤ãæ™‚æœŸ', 'åå®˜': 'å®ŸåŠ›ç™ºæ®ã€å›°é›£ã‚’ä¹—ã‚Šè¶Šãˆã‚‹æ™‚æœŸ',
                'å°ç¶¬': 'å­¦ç¿’ã¨æˆé•·ã€çŸ¥è­˜ã‚„æŠ€è¡“ç¿’å¾—ã®æ™‚æœŸ', 'åå°': 'ç‹¬å‰µæ€§ç™ºæ®ã€æ–°ã—ã„åˆ†é‡ã¸ã®æŒ‘æˆ¦ã®æ™‚æœŸ'
            };
            return fortunes[tenGod] || 'å¤‰åŒ–ã¨æˆé•·ã®æ™‚æœŸ';
        }
    </script>
</body>
</html>

